library(lme4)
library(emmeans)
library(lmerTest)
library(multcompView)
library(multcomp)
library(plyr)
library(perm)
library(lme4)
library(lmerTest)
library(emmeans)
library(pbkrtest)
library(broom.mixed)
#=================================================================#
#OVERALL DATA, full model test across all Schoenoplectus plants

trait.d<-read.csv(file="All_data_plant_measurement_less_samp_corrected.csv")
trait.d[trait.d==0]<-NA
trait.d$Genotype<-as.factor(trait.d$Genotype)
options(contrasts = c("contr.sum","contr.poly"))
#GLB
lm.mod.grn2<-lmer(log(greenlf_biom)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                  data=trait.d,na.action=na.omit)
anova(lm.mod.grn2, dff="Satterthwaite")
#AG
agb.mod0<-lmer(log(AG_biom)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
               data=trait.d,na.action=na.omit)
anova(agb.mod0, dff="Satterthwaite") # get the analysis of variance table
#BG
bgb.mod0<-lmer(log(BG_biom)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
               data=trait.d,na.action=na.omit)
anova(bgb.mod0, dff="Satterthwaite")
#Total Biomass
trait.d$total_biom<-trait.d$AG_biom+trait.d$BG_biom
total_b.mod01<-lmer(log(total_biom)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                    data=trait.d,na.action=na.omit)
anova(total_b.mod01, dff="Satterthwaite")
#Total Biomass
trait.d$total_biom<-trait.d$AG_biom+trait.d$BG_biom
total_b.mod01<-lmer(log(total_biom)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                    data=trait.d,na.action=na.omit)
anova(total_b.mod01, dff="Satterthwaite")

#root-to-shoot ratio
trait.d$rtst<-trait.d$BG_biom/trait.d$AG_biom
rtst.mod1<-lmer(log(rtst)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                data=trait.d,na.action=na.omit)
anova(rtst.mod1, dff="Satterthwaite")
#significant interaction so
#Post-hoc tests:
emm<-emmeans(rtst.mod1, pairwise~Salinity:Mbiome.trt:Site)
emm
summary(emm, infer = TRUE, null = log(35), type = "response")
all.ht.cld<-multcomp::cld(emm$emmean,alpha=0.05, Letters=letters, adjust="tukey",type="response")
all.ht.cld

#height
height.mod01<-lmer(log(final_aveheight)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                   data=trait.d,na.action=na.omit)
anova(height.mod01, dff="Satterthwaite")
#Post-hoc tests:
emm<-emmeans(height.mod01,pairwise~Salinity:Mbiome.trt:Site,adjust="tukey", alpha=0.05, Letters=letters,type="response")
emm
summary(emm, infer = TRUE, null = log(35), type = "response")
all.ht.cld<-multcomp::cld(emm$emmean,alpha=0.05, Letters=letters, adjust="tukey",type="response")
all.ht.cld
#visualize nature of interaction
emmip(height.mod01, Salinity ~ Mbiome.trt | Site)

trait.d$plantsize<-trait.d$stemdiam_ave*trait.d$final_aveheight
size.mod0<-lmer(log(plantsize)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                data=trait.d,na.action=na.omit)
anova(size.mod0, dff="Satterthwaite")

#Stem number 
trait.d<-read.csv(file="All_data_plant_measurement_less_samp_corrected.csv")
trait.d[trait.d==0]<-NA
trait.d$Genotype<-as.factor(trait.d$Genotype)
options(contrasts = c("contr.sum","contr.poly"))
#transform
trait.d$sqstem_num<-sqrt(trait.d$stem_num)
stem.num.mod1<-lmer(sqrt(trait.d$stem_num)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                    data=trait.d,na.action=na.omit)
anova(stem.num.mod1, dff="Satterthwaite") # get the analysis of variance table
#Post-hoc tests:
#need to regrid because sqrt transformation is used
sn.rg <- ref_grid(stem.num.mod1)
emm.sn.regrid<-emmeans(regrid(sn.rg), pairwise~Salinity:Mbiome.trt:Site,adjust="tukey", alpha=0.05, transform = "log",type="response")
emm.sn.regrid
all.sn.cld<-multcomp::cld(emm.sn.regrid$emmean,alpha=0.05, Letters=letters, adjust="tukey",type="response")

#SD
#area of each pot = 36 cm2
trait.d$stemden<-trait.d$stem_num/36
stemden.mod1<-lmer(log(stemden)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                   data=trait.d,na.action=na.omit)
anova(stemden.mod1, dff="Satterthwaite")
#Post-hoc tests:
emm3<-emmeans(stemden.mod1,pairwise~Salinity:Mbiome.trt:Site,adjust="tukey", alpha=0.05, Letters=letters,type="response")
emm3
#cld(emm2$emmean)
all.ht.cld<-multcomp::cld(emm3$emmean,alpha=0.05, Letters=letters, adjust="tukey",type="response")
all.ht.cld

#Stem diameter
diam.mod0<-lmer(log(stemdiam_ave)~Salinity*Mbiome.trt*Site+Cohort+initial_wt_grams+(1|Genotype), 
                data=trait.d,na.action=na.omit)
anova(diam.mod0, dff="Satterthwaite")
#Post-hoc tests:
emm4<-emmeans(diam.mod0,pairwise~Salinity:Mbiome.trt:Site,adjust="tukey", alpha=0.05, Letters=letters,type="response")
emm4
#cld(emm4$emmean)
all.ht.cld<-multcomp::cld(emm4$emmean,alpha=0.05, Letters=letters, adjust="tukey",type="response")
all.ht.cld

#*****************************#
#getting BLUPs / reaction norm
#SELLMAN
#Plot only those where Salinity|Genotype model was significant
trait.d<-read.csv(file="All_data_plant_measurement_less_samp_corrected.csv")
sellman<-trait.d[trait.d$Site=="Sellman",]
#replace 0 with NAs
sellman[sellman==0]<-NA
sellman$Genotype<-as.factor(sellman$Genotype)
options(contrasts = c("contr.sum","contr.poly"))

#GLB
lm.mod.grn1<-lmer(log(greenlf_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                  data=sellman,na.action=na.omit)
#vary slope then compare to model with varying intercept
lm.mod.grn2<-lmer(log(greenlf_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                  data=sellman,na.action=na.omit)
lm.mod.grn3<-lmer(log(greenlf_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                  data=sellman,na.action=na.omit)
anova(lm.mod.grn1,lm.mod.grn3,lm.mod.grn2, test="FIML") # test if genotype is significant

#AG
agb.mod0<-lmer(log(AG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
               data=sellman,na.action=na.omit)
agb.mod1<-lmer(log(AG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
               data=sellman,na.action=na.omit)
agb.mod2<-lmer(log(AG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
               data=sellman,na.action=na.omit)
anova(agb.mod0,agb.mod1,agb.mod2, method="FIML")
#model 2 is significant
#get BLUPS
blups_agb<- broom.mixed::tidy(agb.mod2, effects="ran_vals") #back transform
blups_agb #get estimate and std.error
write.table(blups_agb, file="AG_blups_sellman_28Oct.csv",sep=',')
bgb.mod0<-lmer(log(BG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
               data=sellman,na.action=na.omit)
bgb.mod2<-lmer(log(BG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
               data=sellman,na.action=na.omit)
bgb.mod1<-lmer(log(BG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
               data=sellman,na.action=na.omit)
anova(bgb.mod0,bgb.mod1,bgb.mod2)
#get BLUPS
blups_BG<- broom.mixed::tidy(bgb.mod1, effects="ran_vals") #back transform
blups_BG #get estimate and std.error
write.table(blups_BG, file="BG_blups_sellman_28Oct.csv",sep=',')

#plot results BLUPs
sellman$total_biom<-sellman$AG_biom+sellman$BG_biom
total_b.mod0<-lmer(log(total_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                   data=sellman,na.action=na.omit)
total_b.mod1<-lmer(log(total_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                   data=sellman,na.action=na.omit)
total_b.mod2<-lmer(log(total_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                   data=sellman,na.action=na.omit)
anova(total_b.mod1,total_b.mod2,total_b.mod0)

#model 2 is significant
#get BLUPS
blups_totalbiom<- broom.mixed::tidy(total_b.mod2, effects="ran_vals") #back transform
blups_totalbiom #get estimate and std.error
write.table(blups_totalbiom, file="total_biom_blups_sellman_new_28Oct.csv",sep=',')

sellman$rtst<-sellman$BG_biom/sellman$AG_biom

rtst.mod1<-lmer(log(rtst)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                data=sellman,na.action=na.omit)
rtst.mod2<-lmer(log(rtst)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                data=sellman,na.action=na.omit)
rtst.mod3<-lmer(log(rtst)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                data=sellman,na.action=na.omit)
anova(rtst.mod1,rtst.mod2,rtst.mod3)

#height
height.mod00<-lmer(log(final_aveheight)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                   data=sellman,na.action=na.omit)
height.mod01<-lmer(log(final_aveheight)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                   data=sellman,na.action=na.omit)
height.mod02<-lmer(log(final_aveheight)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                   data=sellman,na.action=na.omit)
anova(height.mod00,height.mod01,height.mod02)

sellman$plantsize<-sellman$stemdiam_ave*sellman$final_aveheight
size.mod0<-lmer(log(plantsize)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                data=sellman,na.action=na.omit)
size.mod1<-lmer(log(plantsize)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                data=sellman,na.action=na.omit)
size.mod2<-lmer(log(plantsize)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                data=sellman,na.action=na.omit)
anova(size.mod0,size.mod1,size.mod2)
#model 2 is significant
#get BLUPS
blups_size.sm<- broom.mixed::tidy(size.mod2, effects="ran_vals") #back transform
blups_size.sm #get estimate and std.error
write.table(blups_size.sm, file="size_blups_sellman_28Oct.csv",sep=',')
diam.mod0<-lmer(log(stemdiam_ave)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                data=sellman,na.action=na.omit)
diam.mod1<-lmer(log(stemdiam_ave)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                data=sellman,na.action=na.omit)
diam.mod1<-lmer(log(stemdiam_ave)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                data=sellman,na.action=na.omit)
anova(diam.mod0,diam.mod1)
#SD
#area of each pot = 36 cm2
sellman$stemden<-sellman$stem_num/36
stemden.mod0<-lmer(log(stemden)~Salinity+Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                   data=sellman,na.action=na.omit)
stemden.mod1<-lmer(log(stemden)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                   data=sellman,na.action=na.omit)
stemden.mod2<-lmer(log(stemden)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                   data=sellman,na.action=na.omit)
anova(stemden.mod0,stemden.mod1,stemden.mod2)

#**************#
# CORN
trait.d<-read.csv(file="All_data_plant_measurement_less_samp_corrected.csv")
corn.d<-trait.d[trait.d$Site=="Corn",]
#replace 0 with NAs
corn.d[corn.d==0]<-NA
corn.d$Genotype<-as.factor(corn.d$Genotype)

#GLB
lm.mod.grn1<-lmer(log(greenlf_biom)~Salinity*Mbiome.trt*Cohort+initial_wt_grams+(1|Genotype), 
                  data=corn.d,na.action=na.omit)
#vary slope then compare to model with varying intercept
lm.mod.grn2<-lmer(log(greenlf_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                  data=corn.d,na.action=na.omit)
lm.mod.grn3<-lmer(log(greenlf_biom)~Salinity*Mbiome.trt*Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                  data=corn.d,na.action=na.omit)
anova(lm.mod.grn1,lm.mod.grn3,lm.mod.grn2) # test if genotype 
#AG
agb.mod0<-lmer(log(AG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
               data=corn.d,na.action=na.omit)
agb.mod1<-lmer(log(AG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
               data=corn.d,na.action=na.omit)
agb.mod2<-lmer(log(AG_biom)~Salinity*Mbiome.trt*Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
               data=corn.d,na.action=na.omit)
anova(agb.mod0,agb.mod1,agb.mod2)

#BG
bgb.mod0<-lmer(log(BG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
               data=corn.d,na.action=na.omit)
bgb.mod1<-lmer(log(BG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
               data=corn.d,na.action=na.omit)
bgb.mod2<-lmer(log(BG_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
               data=corn.d,na.action=na.omit)
anova(bgb.mod0,bgb.mod1,bgb.mod2)
#model 2 is significant but deviation is zero so no BLUPS
#Total Biomass
corn.d$total_biom<-corn.d$AG_biom+corn.d$BG_biom

total_b.mod0<-lmer(log(total_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                   data=corn.d,na.action=na.omit)
total_b.mod1<-lmer(log(total_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                   data=corn.d,na.action=na.omit)
total_b.mod2<-lmer(log(total_biom)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                   data=corn.d,na.action=na.omit)
anova(total_b.mod0,total_b.mod1,total_b.mod2)

#root-to-shoot ratio
corn.d$rtst<-corn.d$BG_biom/corn.d$AG_biom

rtst.mod1<-lmer(log(rtst)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                data=corn.d,na.action=na.omit)
rtst.mod2<-lmer(log(rtst)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                data=corn.d,na.action=na.omit)
rtst.mod3<-lmer(log(rtst)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                data=corn.d,na.action=na.omit)
anova(rtst.mod1,rtst.mod2,rtst.mod3)
#Plant height
height.mod00<-lmer(log(final_aveheight)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                   data=corn.d,na.action=na.omit)
height.mod01<-lmer(log(final_aveheight)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                   data=corn.d,na.action=na.omit)
height.mod02<-lmer(log(final_aveheight)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                   data=corn.d,na.action=na.omit)
anova(height.mod00,height.mod01,height.mod02)
#get BLUPS
blups_height.corn<- broom.mixed::tidy(height.mod02, effects="ran_vals") #back transform
blups_height.corn #get estimate and std.error
write.table(blups_height.corn, file="height_blups_corn_28Oct_2.csv",sep=',', row.names=FALSE)
#PS
corn.d$plantsize<-corn.d$stemdiam_ave*corn.d$final_aveheight
size.mod0<-lmer(log(plantsize)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                data=corn.d,na.action=na.omit)
size.mod1<-lmer(log(plantsize)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                data=corn.d,na.action=na.omit)
size.mod2<-lmer(log(plantsize)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                data=corn.d,na.action=na.omit)
anova(size.mod0,size.mod1,size.mod2)
#get BLUPS
blups_size.corn<- broom.mixed::tidy(size.mod2, effects="ran_vals") #back transform
blups_size.corn #get estimate and std.error
write.table(blups_size.corn, file="plantsize_blups_corn_28Oct.csv",sep=',', row.names=FALSE)

#Stem diameter
diam.mod0<-lmer(log(stemdiam_ave)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                data=corn.d,na.action=na.omit)
diam.mod1<-lmer(log(stemdiam_ave)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                data=corn.d,na.action=na.omit)
diam.mod2<-lmer(log(stemdiam_ave)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                data=corn.d,na.action=na.omit)
anova(diam.mod0,diam.mod1,diam.mod2)
#get BLUPS
blups_diam.corn<- broom.mixed::tidy(diam.mod2, effects="ran_vals") #back transform
blups_diam.corn #get estimate and std.error
write.table(blups_diam.corn, file="diam_blups_corn_28Oct.csv",sep=',', row.names=FALSE)
#Stem number 
#transform
corn.d$sqstem_num<-sqrt(corn.d$stem_num)
stem.num.mod1<-lmer(sqstem_num~Salinity*Mbiome.trt*Cohort+initial_wt_grams+(1|Genotype), 
                    data=corn.d,na.action=na.omit)
stem.num.mod2<-lmer(sqstem_num~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                    data=corn.d,na.action=na.omit)
stem.num.mod3<-lmer(sqstem_num~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                    data=corn.d,na.action=na.omit)
anova(stem.num.mod1,stem.num.mod2,stem.num.mod3)
#SD
#area of each pot = 36 cm2
corn.d$stemden<-corn.d$stem_num/36
#no singularity
stemden.mod0<-lmer(log(stemden)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(1|Genotype), 
                   data=corn.d,na.action=na.omit)
stemden.mod1<-lmer(log(stemden)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Salinity|Genotype), 
                   data=corn.d,na.action=na.omit)
stemden.mod2<-lmer(log(stemden)~Salinity*Mbiome.trt+Cohort+initial_wt_grams+(Mbiome.trt|Salinity:Genotype), 
                   data=corn.d,na.action=na.omit)
anova(stemden.mod0,stemden.mod1,stemden.mod2)

#microbe effect  
#change into wide format
df.p<-read.csv(file="All_data_plant_measurement_less_samp_corrected.csv")
df.p$id<-paste(df.p$Genotype,df.p$Clone,sep="-")
df.p$Sal_ino<-paste(df.p$Salinity,df.p$Mbiome.trt,sep="-")
write.table(df.p, file="plant_trait_long.csv", sep=',', row.names=FALSE)
data_wide <- dcast(df.p, id+ Site+Salinity ~ Mbiome.trt, value.var="final_aveheight")
#subtract for microbiome effect
data_wide$mic_eff<-data_wide$Live-data_wide$Sterile
write.table(data_wide, file="plant_trait_wide_height.csv", sep=',', row.names=FALSE)
#plant size
df<-read.csv(file="plant_trait_long.csv")
df$plantsize<-df$stem_num*df$final_aveheight
df.ps<- dcast(df, id+ Site+Salinity+Cohort ~ Mbiome.trt, value.var="plantsize")
#subtract for microbiome effect
df.ps$mic_eff<-df.ps$Live-df.ps$Sterile
write.table(df.ps, file="plant_trait_wide_size.csv", sep=',', row.names=FALSE)
#stem number
df<-read.csv(file="plant_trait_long.csv")
df.sd<- dcast(df, id+ Site+Salinity+Cohort ~ Mbiome.trt, value.var="stem_num")
#subtract for microbiome effect
df.sd$mic_eff<-df.sd$Live-df.sd$Sterile
write.table(df.sd, file="plant_trait_wide_stem_num.csv", sep=',', row.names=FALSE)
#stem_density
df<-read.csv(file="plant_trait_long.csv")
df$stemden<-df$stem_num/36
df.sd<- dcast(df, id+ Site+Salinity+Cohort ~ Mbiome.trt, value.var="stemden")
#subtract for microbiome effect
df.sd$mic_eff<-df.sd$Live-df.sd$Sterile
write.table(df.sd, file="plant_trait_wide_density.csv", sep=',', row.names=FALSE)

#manually parse out the genotype
#GET emmeans
#height
df.all<-read.csv(file="plant_trait_wide_height.csv")
df.all$Genotype<-as.factor(df.all$Genotype)
options(contrasts = c("contr.sum","contr.poly"))
ph.mod<-lmer(mic_eff~Salinity*Site*Cohort+(1|Genotype), 
             data=df.all,na.action=na.omit)
#test for main effects
anova(ph.mod)
#Post-hoc tests:
all.ht.emm<-emmeans(ph.mod, pairwise~Salinity:Cohort:Site)
all.ht.emm
summary(all.ht.emm, infer = TRUE, null = log(35), type = "response")
all.ht.cld<-multcomp::cld(all.ht.emm$emmean,alpha=0.05, Letters=letters, adjust="tukey")
all.ht.cld
#SN
df.sn<-read.csv(file="plant_trait_wide_stem_num.csv")
df.sn$Genotype<-as.factor(df.sn$Genotype)
options(contrasts = c("contr.sum","contr.poly"))
sn.mod<-lmer(mic_eff~Salinity*Site*Cohort+(1|Genotype), 
             data=df.sn,na.action=na.omit)
#test for main effects
anova(sn.mod)
#Post-hoc tests: get emmeans/lsmeans to plot
sn.emmeans<-eameans(sn.mod, pairwise~Salinity:Cohort:Site)
sn.emmeans
#SD density
df.sd<-read.csv(file="plant_trait_wide_density.csv")
df.sd$Genotype<-as.factor(df.sd$Genotype)
options(contrasts = c("contr.sum","contr.poly"))
den.mod<-lmer(mic_eff~Salinity*Site*Cohort+(1|Genotype), 
              data=df.sd,na.action=na.omit)
#test for main effects
anova(den.mod)
#Post-hoc tests: 
den.emmeans<-emmeans(den.mod, pairwise~Salinity:Cohort:Site)
den.emmeans

#PLSR
fundiv<-read.csv(file="FinalData_scam_root_fungi.csv")
#replace 0 with NAs
fundiv[fundiv==0]<-NA
fundiv$Genotype<-as.factor(fundiv$Genotype)
#perform plsr
fundiv$total_biom<-fundiv$AG_biom+fundiv$BG_biom
fundiv$stemden<-fundiv$stem_num/36
fundiv$RS<-fundiv$BG_biom/fundiv$AG_biom
fundiv$PS<-fundiv$stem_num*fundiv$final_aveheight
fun.div.pls<-plsr(enspie~scale(final_aveheight)+scale(AG_biom) +scale(BG_biom)+
                    scale(greenlf_biom)+scale(RS)+scale(PS)+
                    scale(stem_num)+scale(stemdiam_ave)+scale(stemden),
                  data=fundiv, validation="CV")
# Find the number of dimensions with lowest cross validation error
cv<-RMSEP(fun.div.pls)
best.dims<-which.min(cv$val[estimate = "adjCV", , ]) - 1
best.dims
# Rerun the model
new.fundiv.plsr<-plsr(enspie~scale(final_aveheight)+scale(AG_biom) +scale(BG_biom)+
                        scale(greenlf_biom)+scale(RS)+scale(PS)+
                        scale(stem_num)+scale(stemdiam_ave)+scale(stemden), 
                      data=fundiv, ncomp = 2, validation="CV", scale=FALSE,jackknife = TRUE)
summary(new.fundiv.plsr)
jack.test(new.fundiv.plsr,ncomp=1:2, use.mean = TRUE)
#extract coefficient
coefficients<-coef(new.fundiv.plsr, ncomp=1:2)
coefficients
#extract explained variance attributed to components
compnames(new.fundiv.plsr, comps = 1:2, explvar = TRUE)
#comps = 1:2, 
factor=(row.names(coefficients))
coef<-data.frame(factor)
coef
# change name
levels(coef$factor)[levels(coef$factor) =="scale(AG_biom)"]<-"AG"
levels(coef$factor)[levels(coef$factor) =="scale(BG_biom)"]<-"BG"
levels(coef$factor)[levels(coef$factor) =="scale(greenlf_biom)"]<-"GB"
#levels(coef$factor)[levels(coef$factor) =="scale(total_biom)"]<-"Total"
levels(coef$factor)[levels(coef$factor) =="scale(final_aveheight)"]<-"PH"
levels(coef$factor)[levels(coef$factor) =="scale(stem_num)"]<-"SN"
levels(coef$factor)[levels(coef$factor) =="scale(stemdiam_ave)"]<-"SDi"
levels(coef$factor)[levels(coef$factor) =="scale(stemden)"]<-"SD"
levels(coef$factor)[levels(coef$factor) =="scale(RS)"]<-"R:S"
levels(coef$factor)[levels(coef$factor) =="scale(PS)"]<-"PS"
coef
#plot correlation loadings 
tiff("fungi_plsr_corr.tiff", width = 110, height = 110, units = 'mm', res = 300)
plot(new.fundiv.plsr, plottype = "correlation", 
     ploty=FALSE, labels=coef$factor, cex=0.85)
par(new=TRUE)
plot(new.fundiv.plsr, plottype = "correlation", 
     ploty=TRUE, plotx=FALSE, pch=17, col="darkred")
dev.off()
